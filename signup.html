<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TaskTracker Sign Up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --panel: white;
      --text: #333;
      --hint: #666;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
    }

    .box {
      background: var(--panel);
      padding: 40px;
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .logo {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      margin-bottom: 20px;
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
      color: var(--text);
    }

    .subtitle {
      color: var(--hint);
      margin-bottom: 30px;
      font-size: 14px;
    }

    input, select, button {
      width: 100%;
      padding: 14px;
      margin-top: 12px;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      font-size: 16px;
      box-sizing: border-box;
      font-family: inherit;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      background: #000;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .google-btn {
      background: white;
      color: #333;
      border: 2px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .google-btn:hover:not(:disabled) {
      border-color: #667eea;
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: #999;
      font-size: 14px;
    }

    .divider::before, .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #ddd;
      margin: 0 10px;
    }

    .hint {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
      text-align: left;
    }

    .slider-container {
      margin: 20px 0;
      text-align: left;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .age-display {
      color: #667eea;
      font-size: 20px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      height: 6px;
      border-radius: 3px;
      background: #e0e0e0;
      padding: 0;
      margin: 10px 0;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
    }

    .role-box {
      background: linear-gradient(135deg, #667eea20, #764ba220);
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .role-box h3 {
      color: #667eea;
      margin: 0 0 5px 0;
    }

    .role-box p {
      color: #666;
      margin: 0;
      font-size: 14px;
    }

    .avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
      font-weight: bold;
      position: relative;
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: transform 0.2s;
      justify-self: center;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: #333;
      transform: scale(1.15);
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .back-btn {
      background: #f0f0f0;
      color: #333;
    }

    #msg {
      margin-top: 15px;
      color: #dc3545;
      font-size: 14px;
      display: none;
      padding: 10px;
      background: #f8d7da;
      border-radius: 8px;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .login-link {
      margin-top: 20px;
      color: #666;
      font-size: 14px;
    }

    .login-link a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>
<body>

  <!-- STEP 1 -->
  <div class="box step active" id="step1">
    <img src="/images/logo.png" alt="TaskTracker" class="logo" onerror="this.style.display='none'">
    <h1>Create Account</h1>
    <p class="subtitle">Join TaskTracker today</p>

    <button class="google-btn" id="googleBtn">
      <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>

    <div class="divider">or</div>

    <input id="username" placeholder="Choose a username">
    <div class="hint">Letters, numbers, underscores only</div>
    
    <input id="password" type="password" placeholder="Create a password">
    <div class="hint">Min 6 characters</div>
    
    <button id="createBtn">Sign Up</button>
    
    <div id="msg"></div>
    
    <p class="login-link">Already have an account? <a href="/login.html">Sign in</a></p>
  </div>

  <!-- STEP 2 -->
  <div class="box step" id="step2">
    <img src="/images/logo.png" alt="TaskTracker" class="logo" onerror="this.style.display='none'">
    <h1>Welcome to TaskTracker</h1>
    <p class="subtitle">Let's set up your profile</p>

    <div style="font-size: 60px; margin: 20px 0;">ðŸ‘¤</div>

    <div class="slider-container">
      <div class="slider-label">
        <span>How old are you?</span>
        <span class="age-display" id="ageDisplay">25</span>
      </div>
      <input type="range" id="ageSlider" min="5" max="100" value="25">
      <div class="hint">This helps us customize your experience</div>
    </div>

    <div class="row">
      <select id="birthMonth">
        <option value="">Month</option>
        <option value="1">January</option>
        <option value="2">February</option>
        <option value="3">March</option>
        <option value="4">April</option>
        <option value="5">May</option>
        <option value="6">June</option>
        <option value="7">July</option>
        <option value="8">August</option>
        <option value="9">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
      <select id="birthDay">
        <option value="">Day</option>
      </select>
    </div>

    <div class="role-box" id="roleBox">
      <h3>You'll be a Parent</h3>
      <p>Create tasks and reward your kids</p>
    </div>

    <button id="continueBtn">Continue</button>
  </div>

  <!-- STEP 3 -->
  <div class="box step" id="step3">
    <img src="/images/logo.png" alt="TaskTracker" class="logo" onerror="this.style.display='none'">
    <h1>Almost there!</h1>
    <p class="subtitle">Customize your profile</p>

    <div class="avatar-preview" id="avatarPreview" style="background-color: #667eea;">
      <span id="initial">?</span>
    </div>

    <input id="firstName" placeholder="Your first name">

    <div style="text-align: left; margin-top: 20px;">
      <label style="font-weight: 600;">Pick your color</label>
      <div class="color-grid">
        <div class="color-option selected" style="background-color: #667eea;" data-color="#667eea"></div>
        <div class="color-option" style="background-color: #f093fb;" data-color="#f093fb"></div>
        <div class="color-option" style="background-color: #4facfe;" data-color="#4facfe"></div>
        <div class="color-option" style="background-color: #43e97b;" data-color="#43e97b"></div>
        <div class="color-option" style="background-color: #fa709a;" data-color="#fa709a"></div>
        <div class="color-option" style="background-color: #fee140;" data-color="#fee140"></div>
        <div class="color-option" style="background-color: #30cfd0;" data-color="#30cfd0"></div>
        <div class="color-option" style="background-color: #a8edea;" data-color="#a8edea"></div>
        <div class="color-option" style="background-color: #ff9a9e;" data-color="#ff9a9e"></div>
        <div class="color-option" style="background-color: #764ba2;" data-color="#764ba2"></div>
      </div>
    </div>

    <div class="row" style="margin-top: 20px;">
      <button class="back-btn" id="backBtn">Back</button>
      <button id="finishBtn">Let's Go!</button>
    </div>
    
    <div id="msg"></div>
  </div>

  <!-- Load Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Load Google -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Main Script -->
  <script>
    // Initialize Supabase - use window.supabase to avoid redeclaration
    const supabaseClient = window.supabase.createClient(
      "https://uqmvpljozjdkvgqneprp.supabase.co",
      "sb_publishable_pWNEEuLuDxj9MZ9ImAF1ag_rORKuvCL"
    );

    // User data
    let userData = {
      username: '',
      password: '',
      email: '',
      google: false,
      age: 25,
      role: 'parent',
      color: '#667eea',
      firstName: ''
    };

    // Check if logged in
    if (localStorage.getItem('uuid')) {
      location.href = '/index.html';
    }

    // Fill days dropdown
    for (let i = 1; i <= 31; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i;
      document.getElementById('birthDay').appendChild(opt);
    }

    // Navigation
    function showStep(n) {
      document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
      document.getElementById('step' + n).classList.add('active');
    }

    function showError(msg) {
      const el = document.getElementById('msg');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hideError() {
      document.getElementById('msg').style.display = 'none';
    }

    // STEP 1: Username signup
    async function createAccount() {
      const username = document.getElementById('username').value.trim().toLowerCase();
      const password = document.getElementById('password').value;

      if (!username || !password) {
        showError('Please fill in all fields');
        return;
      }

      if (!/^[a-z0-9_]+$/.test(username)) {
        showError('Username can only contain letters, numbers, and underscores');
        return;
      }

      if (password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
      }

      hideError();

      try {
        const { data: existing } = await supabaseClient
          .from('profiles')
          .select('username')
          .eq('username', username)
          .single();

        if (existing) {
          showError('Username already taken');
          return;
        }

        userData.username = username;
        userData.password = password;
        userData.email = username + '@tasktracker.local';
        showStep(2);
      } catch (err) {
        userData.username = username;
        userData.password = password;
        userData.email = username + '@tasktracker.local';
        showStep(2);
      }
    }

    // Google Sign In
    function googleSignIn() {
      if (typeof google === 'undefined') {
        showError('Google API not loaded yet. Please wait and try again.');
        return;
      }

      try {
        google.accounts.id.initialize({
          client_id: '893961993976-im0orn6nkbj7jusofsbi15fl87r5r5f4.apps.googleusercontent.com',
          callback: handleGoogleCredential,
          auto_select: false,
          cancel_on_tap_outside: true
        });

        google.accounts.id.prompt((notification) => {
          if (notification.isNotDisplayed()) {
            showError('Sign-in popup blocked. Please allow popups for this site.');
          } else if (notification.isSkippedMoment()) {
            showError('Sign-in was skipped. Please try again.');
          }
        });
      } catch (e) {
        showError('Google Sign-In error: ' + e.message);
        console.error(e);
      }
    }

    // Global callback for Google
    window.handleGoogleCredential = async function(response) {
      console.log('Google callback:', response);
      
      if (!response.credential) {
        showError('No credential received from Google');
        return;
      }

      try {
        const base64Url = response.credential.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const json = atob(base64);
        const payload = JSON.parse(json);
        
        userData.email = payload.email;
        userData.google = true;
        userData.firstName = payload.given_name || (payload.name ? payload.name.split(' ')[0] : 'User');
        
        const base = payload.email.split('@')[0];
        let username = base;
        let counter = 1;
        
        while (true) {
          const { data } = await supabaseClient
            .from('profiles')
            .select('username')
            .eq('username', username)
            .single();
          
          if (!data) break;
          username = base + counter;
          counter++;
          if (counter > 100) break;
        }
        
        userData.username = username;
        
        document.getElementById('firstName').value = userData.firstName;
        updateInitial(userData.firstName);
        showStep(2);
        
      } catch (err) {
        console.error('Google error:', err);
        showError('Google sign-in failed: ' + err.message);
      }
    };

    // STEP 2: Age/Birthday
    function updateAge(val) {
      userData.age = parseInt(val);
      document.getElementById('ageDisplay').textContent = val;
      
      const box = document.getElementById('roleBox');
      if (userData.age < 18) {
        userData.role = 'kid';
        box.innerHTML = '<h3>You\'ll be a Kid</h3><p>Complete tasks and earn rewards</p>';
      } else {
        userData.role = 'parent';
        box.innerHTML = '<h3>You\'ll be a Parent</h3><p>Create tasks and reward your kids</p>';
      }
    }

    function goToStep3() {
      const month = document.getElementById('birthMonth').value;
      const day = document.getElementById('birthDay').value;
      
      if (!month || !day) {
        showError('Please select your birthday');
        return;
      }
      
      userData.birthMonth = parseInt(month);
      userData.birthDay = parseInt(day);
      hideError();
      showStep(3);
    }

    function goToStep2() {
      showStep(2);
    }

    // STEP 3: Profile
    function updateInitial(name) {
      document.getElementById('initial').textContent = name ? name[0].toUpperCase() : '?';
    }

    function selectColor(el, color) {
      document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
      userData.color = color;
      document.getElementById('avatarPreview').style.backgroundColor = color;
    }

    async function finish() {
      const firstName = document.getElementById('firstName').value.trim();
      
      if (!firstName) {
        showError('Please enter your name');
        return;
      }
      
      userData.firstName = firstName;
      
      const btn = document.getElementById('finishBtn');
      btn.disabled = true;
      btn.textContent = 'Creating...';
      
      try {
        const { error } = await supabaseClient.from('profiles').insert([{
          username: userData.username,
          first_name: userData.firstName,
          email: userData.email,
          age: userData.age,
          birth_month: userData.birthMonth,
          birth_day: userData.birthDay,
          role: userData.role,
          color: userData.color,
          password: userData.google ? null : userData.password
        }]);
        
        if (error) throw error;
        
        localStorage.setItem('uuid', userData.username);
        localStorage.setItem('username', userData.username);
        localStorage.setItem('firstName', userData.firstName);
        localStorage.setItem('color', userData.color);
        localStorage.setItem('role', userData.role);
        
        location.href = '/index.html';
        
      } catch (err) {
        showError('Error: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Let\'s Go!';
      }
    }

    // Attach event listeners (no inline onclick)
    document.getElementById('createBtn').addEventListener('click', createAccount);
    document.getElementById('googleBtn').addEventListener('click', googleSignIn);
    document.getElementById('ageSlider').addEventListener('input', (e) => updateAge(e.target.value));
    document.getElementById('continueBtn').addEventListener('click', goToStep3);
    document.getElementById('backBtn').addEventListener('click', goToStep2);
    document.getElementById('finishBtn').addEventListener('click', finish);
    document.getElementById('firstName').addEventListener('input', (e) => updateInitial(e.target.value));
    
    // Color picker event listeners
    document.querySelectorAll('.color-option').forEach(el => {
      el.addEventListener('click', () => selectColor(el, el.dataset.color));
    });

    // Enter key handlers
    document.getElementById('username').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('password').focus();
    });
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') createAccount();
    });
  </script>

</body>
</html>
